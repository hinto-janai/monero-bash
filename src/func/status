#!/usr/bin/env bash
# status function, prints multiple helpful stats

status_All()
{
	print_MoneroBashTitle
	print_Version
	echo
	status_System
	[[ $MONERO_VER != "" ]]&& status_Monero
	[[ $P2POOL_VER != "" ]]&& status_P2Pool
	[[ $XMRIG_VER != "" ]]&& status_XMRig
}

status_System()
{
	$bwhite; printf "System: "
	$bgreen; echo "$(uptime -p)"
	echo
}

status_Template()
{
	$bwhite; printf "$NAME_PRETTY: " ;$off
	if pgrep $DIRECTORY/$PROCESS -f &>/dev/null ;then
		$bgreen; echo "online" ;$off

		# ps stats
		ps -o "| %p | %C | %t |" -p $(pgrep $DIRECTORY/$PROCESS -f)

		# process specific stats
		EXTRA_STATS
	else
		$bred; echo "offline" ;$off
	fi
}

status_Monero()
{
	define_Monero
	EXTRA_STATS(){ $binMonero/monerod status ;echo;}
	status_Template
}

status_P2Pool()
{
	define_P2Pool
	EXTRA_STATS()
	{
		$iwhite; printf "Wallet: "
		$white; echo "$WALLET"

		# SHARE OUTPUT VARIABLE
		local shareOutput="$(grep "SHARE FOUND" $DIRECTORY/p2pool.log)"

		# SHARES PER HOUR
		if [[ -z $shareOutput ]]; then
			local sharesFound="0"
		else
			local sharesFound="$(echo "$shareOutput" | wc -l)"
		fi
		local processUnixTime="$(ps -p $(pgrep $DIRECTORY/$PROCESS -f) -o etimes=)"
		local processHours="$(($processUnixTime / 60 / 60))"
		[[ $processHours = 0 ]] && processHours="1"

		# SHARES PER DAY (not floating, 47 hours = 1 day)
		if [[ $processHours -lt 24 ]]; then
			local processDays="1"
		else
			local processDays="$(($processHours / 24))"
		fi

		# SHARES/hour & SHARES/day WITH FLOATING POINT
		local sharesPerHour="$(printf %.2f\\n "$((1000000000 * $sharesFound / $processHours ))e-9")"
		local sharesPerDay="$(printf %.2f\\n "$((1000000000 * $sharesFound / $processDays ))e-9")"

		# LATEST SHARE (stupid amount of sed and pipes, thankfully the output is in memory so it's pretty fast)
		local latestShare="$(echo "$shareOutput" | tail -1 | sed 's/NOTICE .\|Stratum.*: //g' | sed 's/, diff .*, c/ c/' | sed 's/user.*, //')"
		$iblue; printf "Latest share: "
		$white; echo "$latestShare"

		# LATEST PAYOUT
		local latestPayout="$(tac $binP2Pool/p2pool.log | grep -m1 "payout" | sed 's/NOTICE  //' | sed 's/P2Pool //')"
		$ired; echo "$latestPayout"

		# SHARES FOUND
		$igreen; printf "Shares found: "
		$bwhite; printf "$sharesFound "
		echo "($sharesPerHour per hour / $sharesPerDay per day)"

		echo
	}
	status_Template
}

status_XMRig()
{
	define_XMRig
	EXTRA_STATS()
	{
		# WALLET IN xmrig.json
		$iwhite; printf "Wallet: " ;$off
		local wallet="$(grep -m1 "\"user\":" "$xmrigConf" | awk '{print $2}' | tr -d '","')"
		[[ -z $wallet ]] && echo || echo "$wallet"

		# HASHRATE
		local hashrate="$(tac "$binXMRig/xmrig-log" | grep -m1 "speed" | sed "s/].*miner.*speed/] speed/")"
		$ired; printf "Hashrate: "
		$white; echo "$hashrate"

		# SHARES
		local shares="$(tac "$binXMRig/xmrig-log" | grep -m1 "accepted")"
		$igreen; printf "Accepted shares: "
		$white; echo "$shares"

		$iblue; printf "Pool: " ;$off
		grep -m1 "\"url\":" "$xmrigConf" | awk '{print $2}' | tr -d '","'
		echo
	}
	status_Template
}
